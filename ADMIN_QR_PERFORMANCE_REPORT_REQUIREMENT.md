# Admin QR Performance Report - Feature Requirement Document

**Date:** February 3, 2025  
**Status:** Pending Approval  
**Priority:** Medium  
**Requested By:** Admin Team  

---

## 1. Overview

Add a new report tab in the Admin Reports module that displays QR code generation and payment performance metrics for all agents. This will allow administrators to monitor agent QR activity, conversion rates, and payment collection across the organization.

---

## 2. Business Requirements

### 2.1 Purpose
- Enable administrators to monitor QR code generation activity across all agents
- Track payment conversion rates and collection performance
- Identify top-performing agents and those needing support
- Export agent QR performance data for analysis and reporting

### 2.2 Target Users
- **Admin** - Full access to all agent QR performance data
- **Life Admin** - Access to life insurance agent QR performance
- **Motor Admin** - Access to motor insurance agent QR performance  
- **Health Admin** - Access to health insurance agent QR performance

### 2.3 Business Value
- Improved visibility into agent QR generation activity
- Data-driven insights for agent performance management
- Better tracking of payment collection efficiency
- Exportable data for management reporting

---

## 3. Functional Requirements

### 3.1 New Report Tab: "QR Performance"

Add a new tab to the existing Admin Reports page (`src/pages/admin/Reports.jsx`) alongside:
- Agent Summary
- Detailed Logs
- Customer Status
- **QR Performance** (NEW)

### 3.2 Filters

The QR Performance report should support the following filters:

1. **Date Range**
   - Start Date (date picker)
   - End Date (date picker)
   - Default: Last 30 days

2. **Line of Business** (dropdown)
   - All LOBs
   - Life Insurance
   - Health Insurance
   - Motor Insurance
   - Non-Motor Insurance

3. **Agent** (dropdown)
   - All Agents
   - Individual agent selection
   - List should show: Agent Name (Email)

4. **QR Type** (dropdown)
   - All Types
   - Quick QR
   - Customer Detail

### 3.3 Summary Metrics (Cards)

Display 6 summary cards at the top of the report:

1. **Total QRs Generated**
   - Count of all QR codes generated by all agents
   - Icon: QR Code icon
   - Color: Blue

2. **Total Payments Received**
   - Count of QR codes that resulted in payment
   - Icon: Check Circle icon
   - Color: Green

3. **Overall Conversion Rate**
   - Percentage: (Payments Received / QRs Generated) × 100
   - Icon: Trending Up icon
   - Color: Purple

4. **Total Amount Generated**
   - Sum of all QR code amounts (MUR)
   - Icon: Bar Chart icon
   - Color: Blue

5. **Total Amount Collected**
   - Sum of all payments received (MUR)
   - Icon: Bar Chart icon
   - Color: Green

6. **Overall Collection Rate**
   - Percentage: (Amount Collected / Amount Generated) × 100
   - Icon: Trending Up icon
   - Color: Orange

### 3.4 Two View Options: Summary & Detailed Transactions

The QR Performance tab should have **TWO sub-views** (similar to existing Reports structure):

#### 3.4.1 View 1: Agent Summary (Default)

Display a sortable table with the following columns:

| Column | Description | Sortable |
|--------|-------------|----------|
| **Agent Name** | Agent full name | Yes |
| **Email** | Agent email address | Yes |
| **QRs Generated** | Total QR codes created | Yes |
| **Payments Received** | Number of paid QRs | Yes |
| **Conversion Rate** | (Paid / Generated) × 100% | Yes |
| **Amount Generated** | Total MUR value of QRs | Yes |
| **Amount Collected** | Total MUR collected | Yes |
| **Collection Rate** | (Collected / Generated) × 100% | Yes |
| **Last Activity** | Date of last QR generation | Yes |

**Table Features:**
- Sortable columns (click header to sort)
- Pagination (20 agents per page)
- Search box to filter by agent name or email
- Highlight top 3 performers (green background)
- Highlight bottom 3 performers (yellow background)

#### 3.4.2 View 2: All QR Transactions (Detailed)

Display ALL individual QR transactions with the following columns:

| Column | Description | Sortable |
|--------|-------------|----------|
| **Date/Time** | QR generation timestamp | Yes |
| **Agent Name** | Agent who generated QR | Yes |
| **Agent Email** | Agent email address | Yes |
| **Customer Name** | Customer name | Yes |
| **Policy Number** | Policy number | Yes |
| **LOB** | Line of Business | Yes |
| **QR Type** | Quick QR / Customer Detail | Yes |
| **Amount** | QR amount (MUR) | Yes |
| **Payment Amount** | Actual payment received | Yes |
| **Status** | Pending / Paid / Expired | Yes |
| **Paid Date** | Payment timestamp | Yes |

**Table Features:**
- Sortable columns (click header to sort)
- Pagination (50 transactions per page)
- Search box to filter by agent name, customer name, or policy number
- Status badges with color coding (green=paid, yellow=pending, red=expired)
- Export filtered results to CSV

**Toggle Between Views:**
- Add a toggle/tab switcher at the top: `[Agent Summary] [All Transactions]`
- Both views respect the same filters (date range, LOB, agent, QR type)
- Both views can be exported to CSV separately

### 3.5 Export Functionality

**Export to CSV Button:**
- Location: Top right of the page (next to existing Export CSV button)
- Label: "Export QR Performance" (changes based on active view)
- Icon: Download icon
- Color: Green

**CSV File Contents (Agent Summary View):**
- Filename: `qr_agent_summary_YYYY-MM-DD_to_YYYY-MM-DD.csv`
- Columns:
  - Agent Name
  - Agent Email
  - Agent ID
  - QRs Generated
  - Payments Received
  - Conversion Rate (%)
  - Amount Generated (MUR)
  - Amount Collected (MUR)
  - Collection Rate (%)
  - Last Activity Date
  - Date Range (Start - End)

**CSV File Contents (All Transactions View):**
- Filename: `qr_all_transactions_YYYY-MM-DD_to_YYYY-MM-DD.csv`
- Columns:
  - Transaction ID
  - Date/Time Generated
  - Agent Name
  - Agent Email
  - Agent ID
  - Customer Name
  - Policy Number
  - Line of Business
  - QR Type
  - Amount (MUR)
  - Payment Amount (MUR)
  - Status
  - Paid Date/Time
  - Date Range (Start - End)

---

## 4. Technical Requirements

### 4.1 Data Source

**Primary Table:** `nic_qr_transactions`

**Required Fields:**
- `agent` (agent ID)
- `agent_name` (agent name)
- `agent_email` (agent email)
- `amount` (QR amount)
- `payment_amount` (actual payment received)
- `status` (pending, paid, expired)
- `line_of_business` (life, health, motor, nonmotor)
- `qr_type` (quick_qr, customer_detail)
- `created_at` (QR generation timestamp)
- `paid_at` (payment timestamp)

**Secondary Table:** `nic_cc_agent`
- Used to get complete agent list with emails
- Filter by active agents only

### 4.2 Service Layer

**New Service Methods:** 

#### Method 1: `qrTransactionService.getAdminQRPerformanceReport(filters)`

**Location:** `src/services/qrTransactionService.js`

**Method Signature:**
```javascript
async getAdminQRPerformanceReport(filters = {}) {
  // filters: { date_from, date_to, line_of_business, agent_id, qr_type }
  // Returns: { success, data: { summary, agentPerformance } }
}
```

**Data Processing:**
1. Fetch all QR transactions within date range
2. Apply LOB, agent, and QR type filters
3. Group transactions by agent_name (since agent ID is not reliable)
4. Calculate metrics for each agent:
   - Total QRs generated
   - Total payments received
   - Conversion rate
   - Amount generated
   - Amount collected
   - Collection rate
   - Last activity date
5. Calculate overall summary metrics
6. Sort agents by conversion rate (descending)
7. Return structured data

#### Method 2: `qrTransactionService.getAllQRTransactions(filters)`

**Location:** `src/services/qrTransactionService.js`

**Method Signature:**
```javascript
async getAllQRTransactions(filters = {}) {
  // filters: { date_from, date_to, line_of_business, agent_id, qr_type, page, per_page }
  // Returns: { success, data: { transactions, total, summary } }
}
```

**Data Processing:**
1. Fetch all individual QR transactions within date range
2. Apply LOB, agent, and QR type filters
3. Include agent email from agent lookup
4. Support pagination (50 per page)
5. Calculate overall summary metrics
6. Return raw transaction list with metadata

### 4.3 Component Structure

**File:** `src/pages/admin/Reports.jsx` (modify existing)

**Changes Required:**
1. Add new tab: "QR Performance"
2. Add state for QR filters (LOB, QR type)
3. Add query for QR performance data
4. Add QR performance table component
5. Add CSV export function for QR data

**New Component (Optional):** `src/components/admin/QRPerformanceTable.jsx`
- Reusable table component for QR performance data
- Includes sorting, pagination, search

### 4.4 Utility Functions

**CSV Export Function:**
```javascript
exportQRPerformanceToCSV(data, filename) {
  // Convert agent performance data to CSV format
  // Include summary metrics in header
  // Download as CSV file
}
```

**Location:** `src/services/reportService.js` (add new method)

---

## 5. UI/UX Requirements

### 5.1 Layout

```
┌─────────────────────────────────────────────────────────────┐
│ Reports & Analytics                    [Export QR Performance]│
│ Agent performance and customer status analysis               │
├─────────────────────────────────────────────────────────────┤
│ Filters                                                      │
│ [Start Date] [End Date] [Agent] [LOB] [QR Type]            │
├─────────────────────────────────────────────────────────────┤
│ [Agent Summary] [Detailed Logs] [Customer Status] [QR Performance]│
├─────────────────────────────────────────────────────────────┤
│ Summary Cards (6 cards in a row)                            │
│ [QRs Generated] [Payments] [Conversion] [Amount Gen] [Amount Collected] [Collection Rate]│
├─────────────────────────────────────────────────────────────┤
│ View Toggle: [Agent Summary] [All Transactions]             │
├─────────────────────────────────────────────────────────────┤
│ AGENT SUMMARY VIEW:                                          │
│ Search: [_____________]                                      │
│                                                              │
│ | Agent Name | Email | QRs | Payments | Conv% | ... |      │
│ |------------|-------|-----|----------|-------|-----|      │
│ | John Doe   | j@... | 50  | 40       | 80%   | ... |      │
│ | Jane Smith | j@... | 30  | 15       | 50%   | ... |      │
│                                                              │
│ [< Previous] Page 1 of 5 [Next >]                          │
├─────────────────────────────────────────────────────────────┤
│ ALL TRANSACTIONS VIEW:                                       │
│ Search: [_____________]                                      │
│                                                              │
│ | Date | Agent | Customer | Policy | LOB | Type | Amount... │
│ |------|-------|----------|--------|-----|------|------...  │
│ | 2/1  | John  | Alice    | P123   | Life| Quick| 5000...  │
│ | 2/1  | Jane  | Bob      | P456   | Motor|Detail| 3000... │
│                                                              │
│ [< Previous] Page 1 of 20 [Next >]                         │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 Visual Design

**Color Scheme:**
- Primary: Blue (#1e40af)
- Success: Green (#16a34a)
- Warning: Orange (#ea580c)
- Danger: Red (#dc2626)
- Purple: (#9333ea)

**Card Styling:**
- White background
- Subtle shadow
- Rounded corners (8px)
- Icon on left, metrics on right
- Colored icon matching metric type

**Table Styling:**
- Striped rows (alternate gray background)
- Hover effect on rows
- Sortable column headers (with arrow icons)
- Top performers: Light green background (#f0fdf4)
- Bottom performers: Light yellow background (#fefce8)

### 5.3 Responsive Design

- **Desktop (>1024px):** 6 cards in a row, full table
- **Tablet (768-1024px):** 3 cards per row, horizontal scroll for table
- **Mobile (<768px):** 2 cards per row, card-based view for agents

---

## 6. Data Flow

### 6.1 Data Fetching Flow

```
User selects filters
    ↓
React Query triggers fetch
    ↓
qrTransactionService.getAdminQRPerformanceReport(filters)
    ↓
Fetch from nic_qr_transactions table (Xano API)
    ↓
Fetch from nic_cc_agent table (for agent emails)
    ↓
Process and aggregate data by agent
    ↓
Calculate metrics (conversion, collection rates)
    ↓
Return structured data
    ↓
Display in UI (cards + table)
```

### 6.2 Export Flow

```
User clicks "Export QR Performance"
    ↓
Get current filtered data
    ↓
Convert to CSV format
    ↓
Add headers and summary
    ↓
Trigger browser download
    ↓
File saved: qr_performance_report_YYYY-MM-DD_to_YYYY-MM-DD.csv
```

---

## 7. Known Issues & Workarounds

### 7.1 Agent ID Issue

**Problem:** The `agent` field in `nic_qr_transactions` table stores `0` for all records instead of actual agent IDs.

**Current Workaround:** Filter by `agent_name` field instead of `agent` ID.

**Impact:** 
- Agent filtering works by name matching
- Need to join with `nic_cc_agent` table to get email addresses
- Potential issue if two agents have the same name

**Recommendation:** Fix the agent ID storage in QR transaction logging (separate task)

### 7.2 Data Accuracy

**Note:** QR performance data depends on:
1. Proper logging when QR codes are generated
2. Webhook updates when payments are received
3. Agent name consistency across transactions

---

## 8. Testing Requirements

### 8.1 Unit Tests

Create test file: `test-admin-qr-performance-report.js`

**Test Cases:**
1. Fetch QR performance data for all agents (summary view)
2. Fetch all QR transactions (detailed view)
3. Filter by date range (both views)
4. Filter by specific agent (both views)
5. Filter by LOB (both views)
6. Filter by QR type (both views)
7. Calculate conversion rates correctly
8. Calculate collection rates correctly
9. Export agent summary to CSV with correct format
10. Export all transactions to CSV with correct format
11. Handle empty data gracefully (both views)
12. Handle agents with no QR activity
13. Toggle between summary and detailed views
14. Pagination works correctly (both views)
15. Search functionality works (both views)

### 8.2 Integration Tests

1. Test with real Xano data
2. Verify agent email retrieval
3. Test pagination with 50+ agents
4. Test sorting by each column
5. Test search functionality
6. Test CSV export with special characters in names

### 8.3 Manual Testing Checklist

- [ ] All filters work correctly (both views)
- [ ] Summary cards show accurate totals
- [ ] Toggle between Agent Summary and All Transactions works
- [ ] Agent Summary table displays all agents with QR activity
- [ ] All Transactions table displays individual QR records
- [ ] Sorting works for all columns (both views)
- [ ] Pagination works correctly (both views)
- [ ] Search filters work properly (both views)
- [ ] CSV export includes all data (agent summary)
- [ ] CSV export includes all data (all transactions)
- [ ] CSV filenames are correct for both views
- [ ] Top/bottom performers are highlighted (summary view)
- [ ] Status badges display correctly (transactions view)
- [ ] Responsive design works on mobile
- [ ] Loading states display correctly
- [ ] Error handling works (no data, API errors)

---

## 9. Implementation Steps

### Phase 1: Backend Service (1-2 hours)
1. Add `getAdminQRPerformanceReport()` method to `qrTransactionService.js`
2. Implement data fetching and aggregation logic
3. Add CSV export utility function to `reportService.js`
4. Test service methods with console logs

### Phase 2: Frontend UI (3-4 hours)
1. Add "QR Performance" tab to Reports page
2. Add LOB and QR Type filter dropdowns
3. Create summary cards component
4. Add view toggle (Agent Summary / All Transactions)
5. Create agent performance table component (summary view)
6. Create all transactions table component (detailed view)
7. Add sorting and pagination logic for both views
8. Add search functionality for both views

### Phase 3: Export Feature (1-2 hours)
1. Implement CSV export button (changes based on active view)
2. Format data for CSV export (agent summary format)
3. Format data for CSV export (all transactions format)
4. Test download functionality for both views
5. Verify CSV file formats

### Phase 4: Testing & Polish (1-2 hours)
1. Create test file with test cases
2. Test all filters and combinations
3. Test with different user roles (admin, life_admin, etc.)
4. Fix any bugs or issues
5. Add loading states and error handling
6. Test responsive design

### Phase 5: Documentation (30 minutes)
1. Update README with new feature
2. Add inline code comments
3. Create user guide for admins
4. Update deployment checklist

**Total Estimated Time:** 8-11 hours

---

## 10. Deployment Checklist

### Pre-Deployment
- [ ] Code review completed
- [ ] All tests passing
- [ ] No console errors
- [ ] Responsive design verified
- [ ] CSV export tested
- [ ] Documentation updated

### Deployment Steps
1. Commit changes to Git
2. Push to repository
3. Build production bundle: `npm run build`
4. Deploy to VPS
5. Clear browser cache
6. Test on production environment
7. Notify admin users of new feature

### Post-Deployment
- [ ] Verify feature works in production
- [ ] Test with real admin accounts
- [ ] Monitor for errors in logs
- [ ] Gather user feedback
- [ ] Create training materials if needed

---

## 11. Future Enhancements (Optional)

### 11.1 Advanced Analytics
- Line chart showing QR generation trends over time
- Bar chart comparing agent performance
- Pie chart showing LOB distribution
- Conversion funnel visualization

### 11.2 Additional Filters
- Filter by branch
- Filter by agent type (sales, call center, internal)
- Filter by customer segment
- Filter by payment method

### 11.3 Notifications
- Email alerts for low conversion rates
- Weekly performance summary emails
- Real-time dashboard updates

### 11.4 Benchmarking
- Compare agent performance to team average
- Show percentile rankings
- Identify best practices from top performers

---

## 12. Dependencies

### Required Files
- `src/pages/admin/Reports.jsx` (modify)
- `src/services/qrTransactionService.js` (modify)
- `src/services/reportService.js` (modify)
- `test-admin-qr-performance-report.js` (create)

### Required APIs
- Xano: `nic_qr_transactions` table (read access)
- Xano: `nic_cc_agent` table (read access)

### Required Packages
- All dependencies already installed (React Query, Lucide icons, etc.)

---

## 13. Approval & Sign-off

**Prepared By:** AI Assistant  
**Date:** February 3, 2025  

**Approval Required From:**
- [ ] Product Owner / Project Manager
- [ ] Technical Lead
- [ ] Admin User Representative

**Approved By:** ___________________  
**Date:** ___________________  

**Implementation Start Date:** ___________________  
**Target Completion Date:** ___________________  

---

## 14. Questions & Clarifications

1. Should the report include inactive agents or only active agents?
   - **Recommendation:** Only active agents

2. Should we show agents with zero QR activity?
   - **Recommendation:** Yes, show all agents with a note "No activity"

3. What should be the default sort order?
   - **Recommendation:** Agent Summary: Sort by conversion rate (descending); All Transactions: Sort by date (newest first)

4. Should we add role-based filtering (admin sees all, life_admin sees only life agents)?
   - **Recommendation:** Yes, apply same LOB filtering as other reports

5. Should the CSV export include summary metrics?
   - **Recommendation:** Yes, add summary row at the top for both export types

6. What should be the default view when opening QR Performance tab?
   - **Recommendation:** Agent Summary view (most commonly used)

7. Should the All Transactions view show transactions from all agents or filtered agents only?
   - **Recommendation:** Respect the agent filter - if "All Agents" selected, show all; if specific agent selected, show only that agent's transactions

---

## 15. Contact & Support

For questions or clarifications about this requirement:
- Technical Questions: Development Team
- Business Questions: Admin Team / Management
- Implementation Support: Project Lead

---

**Document Version:** 1.0  
**Last Updated:** February 3, 2025  
**Status:** Awaiting Approval
